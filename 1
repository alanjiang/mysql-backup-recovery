
#!/usr/local/bin/python3

"""
Will backup all the databases listed, will put files in same DIR as script'
To run: $ python dbbackup.py OR python3 dbbackup.py
"""
import pexpect # interactive for user
import configparser
import os
import time
import getpass
import json
import subprocess
import sys
import argparse

def load_config(config_file):
    """加载配置文件"""
    with open(config_file, 'r') as f:
        return json.load(f)
def get_dump(database,confg,filestamp):
    #filestamp = time.strftime('%Y-%m-%d')
    os.makedirs(filestamp, exist_ok=True)
    # D:/xampp/mysql/bin/mysqldump for xamp windows
    cmd = f"mysqldump -h {config['mysql_host']} -P {config['mysql_port']} -u {config['mysql_user']} -p {database}"
    print(f' cmd = {cmd}')
    backup_file = f"{filestamp}/{database}_{filestamp}.sql"
    child = pexpect.spawn(cmd, timeout=3600)
    child.expect('Enter password:')
    child.sendline(config['mysql_password'])
    #child.expect(pexpect.EOF)
    output = child.read()    
    # until the thread end 
    child.wait()
    with open(backup_file, 'wb') as f:  # written with binary file 
            f.write(output)
    print(f' complete backup ...')    
def save_db(database,date,container_name,config,model):
    try:
        # build the dump file 
        backup_file = f"{date}/{database}_{date}.sql"
        
        # check the file exists or not 
        if not os.path.exists(backup_file):
            print(f"backup file does not exists: {backup_file}")
            return False
        # if you use the utf8mb4_general_ci , skip this line
        cmd = f"sed -i 's/utf8mb4_0900_ai_ci/utf8mb4_general_ci/g' {backup_file} "
        return_code = os.system(cmd)
        if return_code == 0:
           print(' sed success')
        else:
          print(' sed failed ')
          return False 
        # if use the docker mysql for target mysql  database
        if model == 'docker': 
           cmd = f"docker cp {backup_file} mysql-5.7:/tmp/"
           return_code = os.system(cmd)
           if return_code == 0:
             print("copy file success")
           else:
             print("copy file fail") 
             return False 
        # use the non docker mysql 
        else:
           print('use the non target docker mysql')
        if model == 'docker':
           cmd = f"docker exec -i  {container_name}  mysql -h localhost -u {config['dist_user']} -p {database} -e \"source  /tmp/{database}_{date}.sql\""
        else:
           cmd = f"mysql -h {config['dist_host']} -u {config['dist_user']} -p {database} -e \"source  {backup_file}\""

        print(f'executing the cmd: {cmd}')
        
        # start the process
        child = pexpect.spawn(cmd, timeout=3600)
        
        # wait for password tips
        child.expect('Enter password:')
        
        # input the passowrd
        child.sendline(config['dist_password'])
        
        # waiting for task completing 
        child.expect(pexpect.EOF)
        
        # get the output 
        output = child.before.decode('utf-8')
        
        # ge the status of exit 
        child.close()
        exit_status = child.exitstatus
        
        if exit_status == 0:
            print("data import successfully!")
            if output.strip():
                print(f"trace: {output}")
            return True
        else:
            print(f"import task fail: {exit_status}")
            if output.strip():
                print(f"Exception: {output}")
            return False
            
    except pexpect.TIMEOUT:
        print("task timeout")
        return False
    except pexpect.EOF:
        print("cmd unexpectly exit")
        if hasattr(child, 'before'):
            print(f"console: {child.before.decode('utf-8')}")
        return False
    except Exception as e:
        print(f"Exception: {e}")
        return False    



if __name__=="__main__":
    parser = argparse.ArgumentParser()
    config = load_config('./config.py')
    print(f' config = {config}')
    parser.add_argument('--model', '-d', default=config['model'])
    model = args.model
    print(f'model : {model}')
    # fetch all the databases from config file 
    databases = config['mysql_databases'].split(',')
    date = time.strftime('%Y-%m-%d')
    for database in databases:
        get_dump(database,config,date,model)
    for database in databases:
       save_db(database,date,config['container_name'],config,model)
